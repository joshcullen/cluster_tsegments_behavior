---
title: "Estimation of Latent Behavioral States"
author: "Josh Cullen"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  pdf_document: 
    fig_caption: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

# Behavior Estimation

Movement parameters (SL/TA/TAA) have been already used to delineate time segments of different behavioral patterns. This document displays the output of the subsequent stage: the clustering of behavioral time segments into behavioral states. While some of the components of the clustering model are flexible (e.g., setting the max number of behaviors) or may be ambiguous (e.g., attribution of behaviors to clusters of time segments), this model relies on the user experience with and knowledge of their study organism. Given prior knowledge about how the focal species moves within their environment, this *a priori* knowledge can be used to guide the assignment of latent behavioral states.

Output of behavioral assignment to time segments (as well as to the whole time series analyzed) will be visualized using multiple methods and components of the data to get a better sense of how the model has clustered time segments, the time series of behavioral changes per individual, and the probability that an organism is in each behavioral state by time segment.


## Identifying behaviors

As stated above, time segments were clustered by similar features of their multinomial (SL, TA) or bernoulli (TAA) distributions. An upper limit of 5 possible behaviors was set when running the model over 1000 iterations. Assuming the gibbs sampler converged after the burn-in period (500 iterations) as determined by the log likelihood asymptoting, the remaining 500 samples were purported to come from the posterior distribution. In some cases, all posterior samples were used in the analysis wheras in others only the maximum *a posteriori* (MAP) value was used to assign behavioral state.

To get a sense of what behaviors were identified, heatmaps using all 64 time segments from all four individuals (**IDs 1, 12, 19, 27**) were plotted for each of the movement parameters. Filled values of these heatmaps represent the proportion of observations within a given time segment per movement parameter (SL, TA, TAA). TA is identified as 'y1' with bins 1-8, SL is identified as 'y2' with bins 1-6, and TAA is identified as 'y3' with a single bin representative of maintaining the same relative direction (positive or negative).  
\hfill\break

```{r load}
library('Rcpp')
library('MCMCpack')
library(dplyr)
library(purrr)
library(tidyr) #for gather function
library(ggplot2)
library(ggnewscale) #for multiple fill scales in ggplot2
library(pals) # for more color palettes
library(progress) #for progress bar
library(sf)
library(rnaturalearth)
library(rnaturalearthdata)
library(cowplot)

#get functions
sourceCpp('aux1.cpp')
source('gibbs functions.R')
source('gibbs sampler2.R')
source('helper functions.R')

#get data
dat<- read.csv('Snail Kite Gridded Data_behav.csv', header = T, sep = ',')
dat.list<- df.to.list(dat)
obs<- get.summary.stats_behav(dat)
obs.list<- df.to.list(obs)

```


```{r gibb sampler, fig.width=4.5, fig.height=3, fig.align='center'}
set.seed(1)

#basic settings
ngibbs=1000
nclustmax=5



#progress bar
pb <- progress_bar$new(
  format = " iteration (:current/:total) [:bar] :percent [Elapsed: :elapsed, Remaining: :eta]",
  total = ngibbs, clear = FALSE, width= 100)

# Run Gibbs sampler
res=cluster.tsegm.behavior(dat=obs[,-1],a.theta3=a.theta3,b.theta3=b.theta3,psi=psi,
                                gamma1=gamma1,nclustmax=nclustmax,ngibbs=ngibbs)

plot(res$loglikel,type='l', xlab = "Iteration", ylab = "Log Likelihood")


#Find MAP value for assignment of clusters
MAP<- which(res$loglikel==max(res$loglikel))  # iteration 711
tbsp.clust<- res$z[MAP,]

#Create DF of clusters by behavioral time segment
behav.seg<- 1:nrow(obs)
tbsp.clust<- cbind(tbsp.clust,behav.seg) %>% data.frame()

```


```{r sep behaviors}
## Separate by Behavior to Compare Distribs (Using Proportions) Over Time

#convert from raw obs to proportion
y1<- obs[,grep('y1',colnames(obs))]
y1.prop<- apply(y1, 1, function(x) {x/sum(x)}) %>% t()

y2<- obs[,grep('y2',colnames(obs))]
y2.prop<- apply(y2, 1, function(x) {x/sum(x)}) %>% t()

y3<- obs[,grep('y3',colnames(obs))]
n<- apply(y2,1,sum)
y3.prop<- y3/n

obs.prop<- cbind(id = obs$id, y1.prop, y2.prop, y3 = y3.prop) %>% data.frame()


#format data
nobs=nrow(obs.prop)
nloc=ncol(obs.prop[,-1])
obs.prop.long<- obs.prop[,-1] %>% data.frame() %>% gather(key, value) %>%
  mutate(behav.seg=rep(1:nobs, times=nloc))  #time is now obs #, not segment #
obs.prop.long$key<- as.factor(obs.prop.long$key)


#separate behavior DFs
b<- left_join(obs.prop.long, tbsp.clust, by = "behav.seg")
b1<- b %>% filter(tbsp.clust == 1)
b2<- b %>% filter(tbsp.clust == 2)
b3<- b %>% filter(tbsp.clust == 3)
b4<- b %>% filter(tbsp.clust == 4)
b5<- b %>% filter(tbsp.clust == 5)
```
\hfill\break


```{r thetas}
theta1.post<- res$theta1[501:ngibbs,] %>% apply(2, mean)
theta2.post<- res$theta2[501:ngibbs,] %>% apply(2, mean)
theta3.post<- res$theta3[501:ngibbs,] %>% apply(2, mean)

#create DF with matching thetas per behavior for all observations
theta1<- matrix(theta1.post, nclustmax, ncol(y1), byrow = F)
theta2<- matrix(theta2.post, nclustmax, ncol(y2), byrow = F)
theta3<- matrix(theta3.post, nclustmax, 1, byrow = F)
colnames(theta1)=paste0('theta1.',1:ncol(y1))
colnames(theta2)=paste0('theta2.',1:ncol(y2))
colnames(theta3)='theta3'

```


```{r}
#plot b1 (Directed; large SL, TA near 0, high TAA)
ggplot() +
  geom_tile(data=b1, aes(x=as.factor(behav.seg), y=key, fill=value)) +
  scale_fill_viridis_c("Proportion") +
  scale_y_discrete(expand = c(0,0)) +
  scale_x_discrete(expand = c(0,0)) +
  geom_hline(aes(yintercept = c(8.5, 14.5)), color = "white", size = 0.35) +
  labs(x = "Time Segment", y = "Behavior Profile", title = "Behavior 1") +
  theme_bw() +
  theme(axis.title = element_text(size = 16), axis.text = element_text(size = 14))
```

```{r}
#plot distributions
theta1.b1<- data.frame(value = theta1[1,])
theta1.b1$bin<- 1:8
theta2.b1<- data.frame(value = theta2[1,])
theta2.b1$bin<- 1:6
theta3.b1<- data.frame(value = c(1 - theta3[1,], theta3[1,]))
theta3.b1$bin<- c("n0", "n1")

ta1<- ggplot(data=theta1.b1, aes(x=bin, y=value)) +
  geom_bar(stat = 'identity') +
  labs(x = "TA bin", y = "Proportion") +
  theme_bw() +
  theme(axis.title = element_text(size = 16), axis.text = element_text(size = 14))

sl1<- ggplot(data=theta2.b1, aes(x=bin, y=value)) +
  geom_bar(stat = 'identity') +
  labs(x = "SL bin", y = "Proportion") +
  theme_bw() +
  theme(axis.title = element_text(size = 16), axis.text = element_text(size = 14))

taa1<- ggplot(data=theta3.b1, aes(x=bin, y=value)) +
  geom_bar(stat = 'identity') +
  labs(x = "TAA bin", y = "Proportion") +
  theme_bw() +
  theme(axis.title = element_text(size = 16), axis.text = element_text(size = 14))

plot_grid(ta1, sl1, taa1, nrow = 1, labels = "")

```


Filled values in the heatmap represent proportions of bins per movement parameter based on the MAP value assignments of behavior. This behavior primarily defined by long step lengths, low turning angles, and high turning angle autocorrelation (as determined from the mean of the posterior distribution of $\theta$). This would likely be classified as a 'directed' or 'transit' behavior.
\hfill\break


```{r}
#plot b2 (Exploratory; intermediate SL, varied TA, intermediate TAA)
ggplot() +
  geom_tile(data=b2, aes(x=as.factor(behav.seg), y=key, fill=value)) +
  scale_fill_viridis_c("Proportion") +
  scale_y_discrete(expand = c(0,0)) +
  scale_x_discrete(expand = c(0,0)) +
  geom_hline(aes(yintercept = c(8.5, 14.5)), color = "white", size = 0.35) +
  labs(x = "Time Segment", y = "Behavior Profile", title = "Behavior 2") +
  theme_bw() +
  theme(axis.title = element_text(size = 16), axis.text = element_text(size = 14))
```

```{r}
#plot distributions
theta1.b2<- data.frame(value = theta1[2,])
theta1.b2$bin<- 1:8
theta2.b2<- data.frame(value = theta2[2,])
theta2.b2$bin<- 1:6
theta3.b2<- data.frame(value = c(1 - theta3[2,], theta3[2,]))
theta3.b2$bin<- c("n0", "n1")

ta2<- ggplot(data=theta1.b2, aes(x=bin, y=value)) +
  geom_bar(stat = 'identity') +
  labs(x = "TA bin", y = "Proportion") +
  theme_bw() +
  theme(axis.title = element_text(size = 16), axis.text = element_text(size = 14))

sl2<- ggplot(data=theta2.b2, aes(x=bin, y=value)) +
  geom_bar(stat = 'identity') +
  labs(x = "SL bin", y = "Proportion") +
  theme_bw() +
  theme(axis.title = element_text(size = 16), axis.text = element_text(size = 14))

taa2<- ggplot(data=theta3.b2, aes(x=bin, y=value)) +
  geom_bar(stat = 'identity') +
  labs(x = "TAA bin", y = "Proportion") +
  theme_bw() +
  theme(axis.title = element_text(size = 16), axis.text = element_text(size = 14))

plot_grid(ta2, sl2, taa2, nrow = 1, labels = "")

```


The second behavior still has some long step lengths (> 10%), but mainly smaller step lengths, high turning angles, and high turning angle autocorrelation (as determined from the mean of the posterior distribution of $\theta$). This would likely be classified as an 'exploratory' behavior.
\hfill\break


```{r}
#plot b3 (Encamped, very low SL, TA near pi, intermediate TAA)
ggplot() +
  geom_tile(data=b3, aes(x=as.factor(behav.seg), y=key, fill=value)) +
  scale_fill_viridis_c("Proportion") +
  scale_y_discrete(expand = c(0,0)) +
  scale_x_discrete(expand = c(0,0)) +
  geom_hline(aes(yintercept = c(8.5, 14.5)), color = "white", size = 0.35) +
  labs(x = "Time Segment", y = "Behavior Profile", title = "Behavior 3") +
  theme_bw() +
  theme(axis.title = element_text(size = 16), axis.text = element_text(size = 14))
```

```{r}
#plot distributions
theta1.b3<- data.frame(value = theta1[3,])
theta1.b3$bin<- 1:8
theta2.b3<- data.frame(value = theta2[3,])
theta2.b3$bin<- 1:6
theta3.b3<- data.frame(value = c(1 - theta3[3,], theta3[3,]))
theta3.b3$bin<- c("n0", "n1")

ta3<- ggplot(data=theta1.b3, aes(x=bin, y=value)) +
  geom_bar(stat = 'identity') +
  labs(x = "TA bin", y = "Proportion") +
  theme_bw() +
  theme(axis.title = element_text(size = 16), axis.text = element_text(size = 14))

sl3<- ggplot(data=theta2.b3, aes(x=bin, y=value)) +
  geom_bar(stat = 'identity') +
  labs(x = "SL bin", y = "Proportion") +
  theme_bw() +
  theme(axis.title = element_text(size = 16), axis.text = element_text(size = 14))

taa3<- ggplot(data=theta3.b3, aes(x=bin, y=value)) +
  geom_bar(stat = 'identity') +
  labs(x = "TAA bin", y = "Proportion") +
  theme_bw() +
  theme(axis.title = element_text(size = 16), axis.text = element_text(size = 14))

plot_grid(ta3, sl3, taa3, nrow = 1, labels = "")

```


The third behavior is much different from the first two, displaying >90% of step lengths within the first bin (smallest SL), ~50% of turning angles near $-\pi/\pi$, and turning angle autocorrelation remaining similar to the other behaviors. Therefore, this behavior represents an 'encamped' or 'resting' behavior.
\hfill\break


```{r}
#plot b4 (ARS, mainly low SL, varied TA, relatively high TAA)
ggplot() +
  geom_tile(data=b4, aes(x=as.factor(behav.seg), y=key, fill=value)) +
  scale_fill_viridis_c("Proportion") +
  scale_y_discrete(expand = c(0,0)) +
  scale_x_discrete(expand = c(0,0)) +
  geom_hline(aes(yintercept = c(8.5, 14.5)), color = "white", size = 0.35) +
  labs(x = "Time Segment", y = "Behavior Profile", title = "Behavior 4") +
  theme_bw() +
  theme(axis.title = element_text(size = 16), axis.text = element_text(size = 14))
```

```{r}
#plot distributions
theta1.b4<- data.frame(value = theta1[4,])
theta1.b4$bin<- 1:8
theta2.b4<- data.frame(value = theta2[4,])
theta2.b4$bin<- 1:6
theta3.b4<- data.frame(value = c(1 - theta3[4,], theta3[4,]))
theta3.b4$bin<- c("n0", "n1")

ta4<- ggplot(data=theta1.b4, aes(x=bin, y=value)) +
  geom_bar(stat = 'identity') +
  labs(x = "TA bin", y = "Proportion") +
  theme_bw() +
  theme(axis.title = element_text(size = 16), axis.text = element_text(size = 14))

sl4<- ggplot(data=theta2.b4, aes(x=bin, y=value)) +
  geom_bar(stat = 'identity') +
  labs(x = "SL bin", y = "Proportion") +
  theme_bw() +
  theme(axis.title = element_text(size = 16), axis.text = element_text(size = 14))

taa4<- ggplot(data=theta3.b4, aes(x=bin, y=value)) +
  geom_bar(stat = 'identity') +
  labs(x = "TAA bin", y = "Proportion") +
  theme_bw() +
  theme(axis.title = element_text(size = 16), axis.text = element_text(size = 14))

plot_grid(ta4, sl4, taa4, nrow = 1, labels = "")

```

The fourth behavior is similar to the second ('exploratory'), but differs in that there are a greater proportion of steps drawn from the first and last bins. While outwardly very similar, this behavior will tentatively referred to as 'area restricted search' (ARS).
\hfill\break


```{r}
#plot b5 (Encamped/Resting2?, mainly low SL, TA closer to pi, relatively high TAA)
ggplot() +
  geom_tile(data=b5, aes(x=as.factor(behav.seg), y=key, fill=value)) +
  scale_fill_viridis_c("Proportion") +
  scale_y_discrete(expand = c(0,0)) +
  scale_x_discrete(expand = c(0,0)) +
  geom_hline(aes(yintercept = c(8.5, 14.5)), color = "white", size = 0.35) +
  labs(x = "Time Segment", y = "Behavior Profile", title = "Behavior 5") +
  theme_bw() +
  theme(axis.title = element_text(size = 16), axis.text = element_text(size = 14))
```

```{r}
#plot distributions
theta1.b5<- data.frame(value = theta1[5,])
theta1.b5$bin<- 1:8
theta2.b5<- data.frame(value = theta2[5,])
theta2.b5$bin<- 1:6
theta3.b5<- data.frame(value = c(1 - theta3[5,], theta3[5,]))
theta3.b5$bin<- c("n0", "n1")

ta5<- ggplot(data=theta1.b5, aes(x=bin, y=value)) +
  geom_bar(stat = 'identity') +
  labs(x = "TA bin", y = "Proportion") +
  theme_bw() +
  theme(axis.title = element_text(size = 16), axis.text = element_text(size = 14))

sl5<- ggplot(data=theta2.b5, aes(x=bin, y=value)) +
  geom_bar(stat = 'identity') +
  labs(x = "SL bin", y = "Proportion") +
  theme_bw() +
  theme(axis.title = element_text(size = 16), axis.text = element_text(size = 14))

taa5<- ggplot(data=theta3.b5, aes(x=bin, y=value)) +
  geom_bar(stat = 'identity') +
  labs(x = "TAA bin", y = "Proportion") +
  theme_bw() +
  theme(axis.title = element_text(size = 16), axis.text = element_text(size = 14))

plot_grid(ta5, sl5, taa5, nrow = 1, labels = "")

```

The last behavior appeared to show many of the same characteristics as behavior 3 (encamped/resting), however the proportion of step lengths from bin 2 was ~20% for the fifth behavior. Therefore, it is expected that this behavior is mostly an extension of behavior 3 or possibly encompassing one or two other behaviors.


## Time series of behavior by ID

Now that the behaviors have been roughly defined, I will now show how this looks over time per individual. This will provide a better sense of the transitions between behaviors and how long each ID spends in certain behaviors. Additionally, plots that display the proportion of behaviors assigned to a given time segment (from the posterior of the *z's*) will be shown to provide a measure of the uncertainty associated with the behavioral assignments from the MAP value.

```{r}
## Separate by ID Showing Time Series

#create DF with matching proportional distrib by time segment for all observations
obs.prop.time<- obs.prop %>% slice(rep(1:n(), times = n))


#format data
obs.prop.list<- df.to.list(obs.prop.time) %>% lapply(function(x) x[!(names(x) %in% c("id"))])
obs.prop.list.long<- lapply(obs.prop.list, function(x) {x %>% gather(key, value) %>%
    mutate(time=rep(1:nrow(x), times=ncol(x)))})
obs.prop.list.long<- lapply(obs.prop.list.long, function(x) {mutate_at(x, "key", as.factor)})

time<- lapply(obs.prop.list, function(x) data.frame(time = 1:nrow(x))) %>% map_dfr(`[`)
tbsp.clust.time<- tbsp.clust %>% slice(rep(1:n(), times = n)) %>%
  mutate(time = time[,1]) %>% mutate(id = dat$id)


## Show Proportion of Behaviors Associated with Each Time Segment (from posterior)

#sample z's from posterior (after burn-in since log-likelihood converged)
z.post<- res$z[501:ngibbs,]
z.post.count<- matrix(0, ncol(z.post), nclustmax)
tmp<-  apply(z.post, 2, table)
for (i in 1:nrow(z.post.count)) {
  z.post.count[i, as.integer(names(tmp[[i]]))]<- tmp[[i]]
}

#convert from count to proportion by time seg
z.post.prop<- apply(z.post.count, 1, function(x) x/sum(x)) %>% t()
colnames(z.post.prop)<- c("Transit","Exploratory","Resting","ARS","Resting2")

#convert to long form for plotting
z.post.prop.time<- cbind(id = obs$id, z.post.prop) %>% data.frame() %>% slice(rep(1:n(), times = n))
z.post.list<- df.to.list(z.post.prop.time) %>% lapply(function(x) x[!(names(x) %in% c("id"))])
z.post.list.long<- lapply(z.post.list, function(x) {x %>% gather(key, value) %>%
    mutate(time=rep(1:nrow(x), times=ncol(x)))})
z.post.list.long<- lapply(z.post.list.long,
                          function(x) {mutate_at(x, "key", factor)})
z.post.list.long<- lapply(z.post.list.long,
                          function(x) {mutate_at(x, "key", ~factor(.,levels(.)[c(5,2,1,4,3)]))})
```

```{r}
# ID 1

#generate boxes denoting clusters
rect.lims1<- rle(tbsp.clust.time[tbsp.clust.time$id == 1, "tbsp.clust"])
rect.lims1$lengths<- cumsum(rect.lims1$lengths)+0.5
rect.lims1$lengths<- c(0.5, rect.lims1$lengths)

rect.lims1.new<- matrix(0, length(rect.lims1$values), 3)
for (i  in 2:length(rect.lims1$lengths)) {
  rect.lims1.new[i-1,]<- c(rect.lims1$lengths[i-1], rect.lims1$lengths[i], rect.lims1$values[i-1])
}
colnames(rect.lims1.new)<- c("xmin","xmax","tbsp.clust")
rect.lims1.new<- data.frame(rect.lims1.new)
rect.lims1.new$tbsp.clust<- factor(rect.lims1.new$tbsp.clust,
                                    labels = c("Transit","Exploratory","Resting","ARS","Resting2"))
rect.lims1.new$tbsp.clust<- factor(rect.lims1.new$tbsp.clust,
                                    levels(rect.lims1.new$tbsp.clust)[c(1:2,4:5,3)], ordered = T)



ggplot() +
  geom_tile(data=obs.prop.list.long[[1]], aes(x=time, y=key, fill=value)) +
  scale_fill_viridis_c("Proportion") +
  scale_y_discrete(expand = c(0,0)) +
  scale_x_continuous(expand = c(0,0)) +
  new_scale_fill() +
  # geom_vline(data = rect.lims1.new, aes(xintercept = xmin), color = "white", size = 0.35) +
  geom_rect(data=rect.lims1.new, aes(xmin = xmin, xmax = xmax,
                                    ymin = max(as.integer(obs.prop.list.long[[1]]$key)) + 0.5,
                                    ymax = max(as.integer(obs.prop.list.long[[1]]$key)) + 1,
                                    fill = as.factor(tbsp.clust)), color = NA, size = 1.5) +
  scale_fill_manual("Behavior", values = ocean.amp(5)) +
  geom_hline(aes(yintercept = c(8.5, 14.5, 15.5)), color = "white", size = 0.5) +
  labs(x = "Time", y = "Behavior Profile", title = "ID 1") +
  theme_bw() +
  theme(axis.title = element_text(size = 18), axis.text = element_text(size = 16),
        plot.title = element_text(size = 18))


ggplot() +
  geom_area(data=z.post.list.long[[1]], aes(x=time, y=value, fill=as.factor(key))) +
  scale_fill_manual("Behavior", values = ocean.amp(5)) +
  scale_y_continuous(expand = c(0,0)) +
  scale_x_continuous(expand = c(0,0)) +
  labs(x = "Time", y = "Proportion of Behavior") +
  theme_bw() +
  theme(axis.title = element_text(size = 18), axis.text = element_text(size = 16))
```


```{r}
# ID 12

#generate boxes denoting clusters
rect.lims12<- rle(tbsp.clust.time[tbsp.clust.time$id == 12, "tbsp.clust"])
rect.lims12$lengths<- cumsum(rect.lims12$lengths)+0.5
rect.lims12$lengths<- c(0.5, rect.lims12$lengths)

rect.lims12.new<- matrix(0, length(rect.lims12$values), 3)
for (i  in 2:length(rect.lims12$lengths)) {
  rect.lims12.new[i-1,]<- c(rect.lims12$lengths[i-1], rect.lims12$lengths[i],
                            rect.lims12$values[i-1])
}
colnames(rect.lims12.new)<- c("xmin","xmax","tbsp.clust")
rect.lims12.new<- data.frame(rect.lims12.new)
rect.lims12.new$tbsp.clust<- factor(rect.lims12.new$tbsp.clust,
                                    labels = c("Transit","Exploratory","Resting","Resting2"))
rect.lims12.new$tbsp.clust<- factor(rect.lims12.new$tbsp.clust,
                                    levels(rect.lims12.new$tbsp.clust)[c(1:2,4:3)], ordered = T)


ggplot() +
  geom_tile(data=obs.prop.list.long[[2]], aes(x=time, y=key, fill=value)) +
  scale_fill_viridis_c("Proportion") +
  scale_y_discrete(expand = c(0,0)) +
  scale_x_continuous(expand = c(0,0)) +
  new_scale_fill() +
  # geom_vline(data = rect.lims1.new, aes(xintercept = xmin), color = "white", size = 0.35) +
  geom_rect(data=rect.lims12.new, aes(xmin = xmin, xmax = xmax,
                                    ymin = max(as.integer(obs.prop.list.long[[2]]$key)) + 0.5,
                                    ymax = max(as.integer(obs.prop.list.long[[2]]$key)) + 1,
                                    fill = as.factor(tbsp.clust)), color = NA, size = 1.5) +
  scale_fill_manual("Behavior", values = ocean.amp(5)[c(1:2,4:5)]) +
  geom_hline(aes(yintercept = c(8.5, 14.5, 15.5)), color = "white", size = 0.5) +
  labs(x = "Time", y = "Behavior Profile", title = "ID 12") +
  theme_bw() +
  theme(axis.title = element_text(size = 18), axis.text = element_text(size = 16),
        plot.title = element_text(size = 18))


ggplot() +
  geom_area(data=z.post.list.long[[2]], aes(x=time, y=value, fill=as.factor(key))) +
  scale_fill_manual("Behavior", values = ocean.amp(5)) +
  scale_y_continuous(expand = c(0,0)) +
  scale_x_continuous(expand = c(0,0)) +
  labs(x = "Time", y = "Proportion of Behavior") +
  theme_bw() +
  theme(axis.title = element_text(size = 18), axis.text = element_text(size = 16))
```


```{r}
# ID 19

#generate boxes denoting clusters
rect.lims19<- rle(tbsp.clust.time[tbsp.clust.time$id == 19, "tbsp.clust"])
rect.lims19$lengths<- cumsum(rect.lims19$lengths)+0.5
rect.lims19$lengths<- c(0.5, rect.lims19$lengths)

rect.lims19.new<- matrix(0, length(rect.lims19$values), 3)
for (i  in 2:length(rect.lims19$lengths)) {
  rect.lims19.new[i-1,]<- c(rect.lims19$lengths[i-1], rect.lims19$lengths[i],
                            rect.lims19$values[i-1])
}
colnames(rect.lims19.new)<- c("xmin","xmax","tbsp.clust")
rect.lims19.new<- data.frame(rect.lims19.new)
rect.lims19.new$tbsp.clust<- factor(rect.lims19.new$tbsp.clust,
                                    labels = c("Transit","Exploratory","Resting","ARS"))
rect.lims19.new$tbsp.clust<- factor(rect.lims19.new$tbsp.clust,
                                    levels(rect.lims19.new$tbsp.clust)[c(1:2,4:3)], ordered = T)


ggplot() +
  geom_tile(data=obs.prop.list.long[[3]], aes(x=time, y=key, fill=value)) +
  scale_fill_viridis_c("Proportion") +
  scale_y_discrete(expand = c(0,0)) +
  scale_x_continuous(expand = c(0,0)) +
  new_scale_fill() +
  # geom_vline(data = rect.lims1.new, aes(xintercept = xmin), color = "white", size = 0.35) +
  geom_rect(data=rect.lims19.new, aes(xmin = xmin, xmax = xmax,
                                    ymin = max(as.integer(obs.prop.list.long[[3]]$key)) + 0.5,
                                    ymax = max(as.integer(obs.prop.list.long[[3]]$key)) + 1,
                                    fill = as.factor(tbsp.clust)), color = NA, size = 1.5) +
  scale_fill_manual("Behavior", values = ocean.amp(5)[c(1:3,5)]) +
  geom_hline(aes(yintercept = c(8.5, 14.5, 15.5)), color = "white", size = 0.5) +
  labs(x = "Time", y = "Behavior Profile", title = "ID 19") +
  theme_bw() +
  theme(axis.title = element_text(size = 18), axis.text = element_text(size = 16),
        plot.title = element_text(size = 18))


ggplot() +
  geom_area(data=z.post.list.long[[3]], aes(x=time, y=value, fill=as.factor(key))) +
  scale_fill_manual("Behavior", values = ocean.amp(5)) +
  scale_y_continuous(expand = c(0,0)) +
  scale_x_continuous(expand = c(0,0)) +
  labs(x = "Time", y = "Proportion of Behavior") +
  theme_bw() +
  theme(axis.title = element_text(size = 18), axis.text = element_text(size = 16))
```


```{r}
# ID 27

#generate boxes denoting clusters
rect.lims27<- rle(tbsp.clust.time[tbsp.clust.time$id == 27, "tbsp.clust"])
rect.lims27$lengths<- cumsum(rect.lims27$lengths)+0.5
rect.lims27$lengths<- c(0.5, rect.lims27$lengths)

rect.lims27.new<- matrix(0, length(rect.lims27$values), 3)
for (i  in 2:length(rect.lims27$lengths)) {
  rect.lims27.new[i-1,]<- c(rect.lims27$lengths[i-1], rect.lims27$lengths[i],
                            rect.lims27$values[i-1])
}
colnames(rect.lims27.new)<- c("xmin","xmax","tbsp.clust")
rect.lims27.new<- data.frame(rect.lims27.new)
rect.lims27.new$tbsp.clust<- factor(rect.lims27.new$tbsp.clust,
                                    labels = c("Resting","ARS"))
rect.lims27.new$tbsp.clust<- factor(rect.lims27.new$tbsp.clust,
                                    levels(rect.lims27.new$tbsp.clust)[c(2:1)], ordered = T)


ggplot() +
  geom_tile(data=obs.prop.list.long[[4]], aes(x=time, y=key, fill=value)) +
  scale_fill_viridis_c("Proportion") +
  scale_y_discrete(expand = c(0,0)) +
  scale_x_continuous(expand = c(0,0)) +
  new_scale_fill() +
  # geom_vline(data = rect.lims1.new, aes(xintercept = xmin), color = "white", size = 0.35) +
  geom_rect(data=rect.lims27.new, aes(xmin = xmin, xmax = xmax,
                                    ymin = max(as.integer(obs.prop.list.long[[4]]$key)) + 0.5,
                                    ymax = max(as.integer(obs.prop.list.long[[4]]$key)) + 1,
                                    fill = as.factor(tbsp.clust)), color = NA, size = 1.5) +
  scale_fill_manual("Behavior", values = ocean.amp(5)[c(3,5)]) +
  geom_hline(aes(yintercept = c(8.5, 14.5, 15.5)), color = "white", size = 0.5) +
  labs(x = "Time", y = "Behavior Profile", title = "ID 27") +
  theme_bw() +
  theme(axis.title = element_text(size = 18), axis.text = element_text(size = 16),
        plot.title = element_text(size = 18))


ggplot() +
  geom_area(data=z.post.list.long[[4]], aes(x=time, y=value, fill=as.factor(key))) +
  scale_fill_manual("Behavior", values = ocean.amp(5)) +
  scale_y_continuous(expand = c(0,0)) +
  scale_x_continuous(expand = c(0,0)) +
  labs(x = "Time", y = "Proportion of Behavior") +
  theme_bw() +
  theme(axis.title = element_text(size = 18), axis.text = element_text(size = 16))
```


## Maps of behavioral assignments by ID

Now that a behavioral state has been assigned to all observations (with a 1 hr time step), these values will be plotted in geographic space to visualize how well these classifications match up with perceived movement patterns.
\hfill\break


```{r, fig.align='center', fig.height=8, fig.width=6}
## Generate Geographic Maps with Pts Assigned a Behavior (from MAP estimate)

#load map data
usa <- ne_states(country = "United States of America", returnclass = "sf")
fl<- usa %>% filter(name == "Florida")
fl<- st_transform(fl, crs = "+init=epsg:32617") #change projection to UTM 17N

tbsp.clust.time$tbsp.clust<- as.factor(tbsp.clust.time$tbsp.clust)
levels(tbsp.clust.time$tbsp.clust)<- c("Transit","Exploratory","Resting","ARS","Resting2")

dat.list$`1`$behav<- tbsp.clust.time[tbsp.clust.time$id == 1, "tbsp.clust"]
dat.list$`12`$behav<- tbsp.clust.time[tbsp.clust.time$id == 12, "tbsp.clust"]
dat.list$`19`$behav<- tbsp.clust.time[tbsp.clust.time$id == 19, "tbsp.clust"]
dat.list$`27`$behav<- tbsp.clust.time[tbsp.clust.time$id == 27, "tbsp.clust"]
dat<- do.call(rbind.data.frame, dat.list)



# Facet plot of maps

ggplot() +
  geom_sf(data = fl) +
  coord_sf(xlim = c(min(dat$utmlong-120000), max(dat$utmlong+40000)),
           ylim = c(min(dat$utmlat-20000), max(dat$utmlat+20000)), expand = FALSE) +
  geom_path(data = dat, aes(x=utmlong, y=utmlat), color="gray60", size=0.25) +
  geom_point(data = dat, aes(utmlong, utmlat, fill=behav), size=2.5, pch=21, alpha=0.7) +
  scale_fill_manual("Behavior", values = ocean.amp(5)) +
  labs(x = "Longitude", y = "Latitude") +
  theme_bw() +
  facet_wrap(~id)
```



